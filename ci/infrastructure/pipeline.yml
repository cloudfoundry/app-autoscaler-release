---
groups:
- name: infrastructure
  jobs:
  - setup-infrastructure
  - deploy-cf
  - delete-cf
  - destroy-infrastructure
  - bosh-cleanup
  - fetch-latest-stemcell
  - deploy-prometheus
  - deploy-postgres
  - deploy-multiapps-controller

- name: others
  jobs:
  - set-pipeline

resource_types:
- name: maven-resource
  type: registry-image
  source:
    repository: ghcr.io/garethjevans/maven-resource
    tag: latest

- name: gcs-resource
  type: registry-image
  source:
    repository: frodenas/gcs-resource

resources:
- name: ci
  type: git
  icon: github
  source:
    uri: git@github.com:cloudfoundry/app-autoscaler-release
    private_key: ((autoscaler-deploy-key-private))
    branch: feature/739-setup-mtar-controller
    fetch_tags: true
    paths:
      - ci/infrastructure
      - ci/autoscaler
      - ci/operations

- name: every-day
  type: time

- name: prometheus-boshrelease
  type: git
  icon: github
  source:
    uri: https://github.com/bosh-prometheus/prometheus-boshrelease.git
    branch: master

- name: postgres-repo
  type: git
  icon: github
  source:
    uri: https://github.com/cloudfoundry/postgres-release.git
    branch: v52


- name: postgres-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/postgres-release
    version: v52


- name: bbl-state
  type: git
  icon: github
  source:
    uri: git@github.com:cloudfoundry/app-autoscaler-env-bbl-state
    private_key: ((autoscaler_bbl_git_key))
    branch: main

- name: autoscaler-env-vars-store
  type: git
  icon: github
  source:
    uri: git@github.com:cloudfoundry/app-autoscaler-env-bbl-state
    private_key: ((autoscaler_bbl_git_key))
    branch: main
    paths:
    - deployment-vars.yml

- name: cf-deployment
  type: git
  icon: github

  source:
    uri: https://github.com/cloudfoundry/cf-deployment.git
    branch: main
    tag_filter: v*

- name: cf-deployment-concourse-tasks
  type: git
  icon: github
  source:
    branch: main
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks.git
    tag_filter: v15.*

- name: gcp-jammy-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-google-kvm-ubuntu-jammy-go_agent

- name: multiapps-controller-repo
  type: git
  icon: github
  source:
    branch: main
    uri: https://github.com/cloudfoundry/multiapps-controller.git


- name: multiapps-controller-artifact
  type: maven-resource
  source:
    # groupId:artifactId:type[:classifier]
    repository: https://repo.maven.apache.org/maven2
    artifactId: multiapps-controller-web
    groupId: org.cloudfoundry.multiapps
    type: war

jobs:
- name: set-pipeline
  public: true
  plan:
  - get: ci
    trigger: true
  - set_pipeline: self
    file: ci/ci/infrastructure/pipeline.yml


- name: setup-infrastructure
  serial_groups: [infra]
  public: true
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: ci
    - get: bbl-state
  - task: setup-infrastructure
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: gcp
      BBL_ENV_NAME: autoscaler
      BBL_GCP_SERVICE_ACCOUNT_KEY: ((autoscaler_app_runtime_interfaces_key))
      BBL_GCP_PROJECT_ID: app-runtime-interfaces-wg
      BBL_GCP_REGION: europe-west3
      BBL_GCP_ZONE: europe-west3-a
      DEBUG_MODE: true
      LB_DOMAIN: autoscaler.app-runtime-interfaces.ci.cloudfoundry.org
      BBL_LB_CERT: ((autoscaler_lb_cert))
      BBL_LB_KEY: ((autoscaler_lb_key))
      TF_VAR_parent_dns_zone: app-runtime-interfaces
    input_mapping:
      bbl-state: bbl-state
      bbl-config: bbl-state
    ensure:
      put: bbl-state
      params:
        repository: updated-bbl-state
        rebase: true

- name: delete-cf
  serial_groups: [infra]
  public: true
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: bbl-state
    - get: cf-deployment-concourse-tasks
  - task: delete-cf
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
    params:
      DEPLOYMENT_NAME: cf
    input_mapping:
      bbl-state: bbl-state

- name: destroy-infrastructure
  serial_groups: [infra]
  public: true
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: bbl-state
    - get: cf-deployment-concourse-tasks
    - get: ci
  - task: check-for-exisiting-deployments
    file: ci/ci/infrastructure/tasks/check-for-existing-deployments.yml
  - task: destroy-infrastructure
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_IAAS: gcp
      BBL_ENV_NAME: autoscaler
      BBL_GCP_SERVICE_ACCOUNT_KEY: ((autoscaler_app_runtime_interfaces_key))
      BBL_GCP_PROJECT_ID: app-runtime-interfaces-wg
    input_mapping:
      bbl-state: bbl-state
    ensure:
      put: bbl-state
      params:
        repository: updated-bbl-state
        rebase: true

- name: bosh-cleanup
  public: true
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: bbl-state
    - get: cf-deployment-concourse-tasks
    - get: every-day
      trigger: true
  - task: bosh-cleanup
    file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml

- name: fetch-latest-stemcell
  public: true
  build_logs_to_retain: 100
  plan:
    - in_parallel:
        - get: bbl-state
        - get: ci
        - get: every-day
          passed: [ bosh-cleanup ]
          trigger: true
        - get: gcp-jammy-stemcell
    - task: fetch-latest-stemcell
      file: ci/ci/autoscaler/tasks/fetch-latest-stemcell.yml

- name: deploy-prometheus
  public: true
  build_logs_to_retain: 100
  serial: true
  plan:
  - in_parallel:
    - get: bbl-state
      trigger: true
      passed: [setup-infrastructure]
    - get: ci
    - get: prometheus-boshrelease
      trigger: true
  - task: deploy-prometheus
    file: ci/ci/infrastructure/tasks/deploy-prometheus.yml
    params:
      BBL_GCP_REGION: europe-west3
      BBL_GCP_ZONE: europe-west3-a
      SLACK_WEBHOOK: ((slack_webhook))

- name: deploy-cf
  serial_groups: [infra]
  public: true
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment
      trigger: true
    - get: prometheus-boshrelease
      trigger: true
    - get: bbl-state
      trigger: true
      passed: [setup-infrastructure]
    - get: autoscaler-env-vars-store
    - get: ci
  - task: combine-ops-files
    file: ci/ci/infrastructure/tasks/combine-ops.yml
    input_mapping:
      app-autoscaler-release: ci
    output_mapping:
      combined-ops: ops-files
  - task: deploy-cf
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      vars-files: autoscaler-env-vars-store
    params:
      SYSTEM_DOMAIN: autoscaler.app-runtime-interfaces.ci.cloudfoundry.org
      OPS_FILES: "operations/cf/scale-to-one-az.yml operations/cf/experimental/add-cflinuxfs4.yml operations/autoscaler/scale_out_cf_for_app-autoscaler.yaml operations/autoscaler/set-cpu-entitlement-per-share.yaml operations/cf/use-compiled-releases.yml operations/autoscaler/enable_mtls.yml operations/prometheus/operators/cf/add-prometheus-uaa-clients.yml operations/prometheus/operators/cf/add-grafana-uaa-clients.yml"
      BOSH_DEPLOY_ARGS: "-v diego_cell_instances=3 -v grafana_redirect_uri=https://grafana.autoscaler.app-runtime-interfaces.ci.cloudfoundry.org/login/generic_oauth"
    ensure:
      put: autoscaler-env-vars-store
      params:
        repository: autoscaler-env-vars-store
        rebase: true
  - task: smoke-tests
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    input_mapping:
      bbl-state: bbl-state
    params:
      ERRAND_NAME: smoke-tests


- name: deploy-postgres
  serial_groups: [infra]
  public: true
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: bbl-state
      trigger: true
      passed: [setup-infrastructure]
    - get: ci
    - get: postgres-repo
    - get: postgres-release
      trigger: true
  - task: deploy-postgres
    file: ci/ci/infrastructure/tasks/deploy-postgres.yml
    params:
      DEBUG: true
      BBL_GCP_REGION: europe-west3
      BBL_GCP_ZONE: europe-west3-a
      SLACK_WEBHOOK: ((slack_webhook))
- name: deploy-multiapps-controller
  serial_groups: [infra]
  public: true
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: bbl-state
      trigger: true
      passed: [setup-infrastructure]
    - get: ci
    - get: multiapps-controller-artifact
    - get: multiapps-controller-repo
  - task: deploy-multiapps-controller
    file: ci/ci/infrastructure/tasks/deploy-multiapps-controller.yml
    params:

